<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Скретч-карусель</title>
    <style>
        body {
            background: #080808;
            font-family: Arial, sans-serif;
            color: white;
            text-align: center;
            margin: 0;
            padding: 25px;
            overflow-x: hidden;
        }

        h1 {
            color: #E91E63;
            font-size: 36px;
            margin-bottom: 0;
            margin-top: 0;
            transition: all 0.3s ease;
        }

        .subtitle {
            font-size: 18px;
            color: #aaa;
            margin-bottom: 25px;
        }

        .carousel-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }

        .carousel {
            display: flex;
            transition: transform 0.5s ease;
            width: 300%;
        }

        .carousel-level {
            width: 33.333%;
            padding: 0 10px;
            box-sizing: border-box;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .scratch-container {
            position: relative;
            width: 100%;
            padding-top: 100%;
            background: #1B1B1B;
            border-radius: 11px;
            overflow: hidden;
        }

        .pagination-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 0 25px 25px;
        }

        .pose-image,
        .scratch-canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            border-radius: 11px;
            object-fit: cover;
            z-index: 1; /* Канвас сверху */
        }

        .pose-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0; /* Картинка внизу */
            transform: scale(0.990);
            transform-origin: center;
        }

        .pagination {
            margin: 25px 0;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .pagination-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #555;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-dot.active {
            background: #E91E63;
        }

        .pagination-arrow {
            color: #E91E63;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            user-select: none;
        }

        .pagination-arrow:hover {
            background: rgba(233, 30, 99, 0.2);
            transform: scale(1.1);
        }

        .pagination-arrow.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .task-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }

        .task-carousel {
            display: flex;
            transition: transform 0.5s ease;
            width: 300%;
        }

        .task-level {
            width: 33.333%;
            padding: 0 10px;
            box-sizing: border-box;
        }

        .task {
            width: 100%;
            height: 150px;
            background: #1B1B1B;
            border-radius: 11px;
            position: relative;
            overflow: hidden;
        }

        .instructions {
            font-size: 10px;
            color: #888;
            margin-top: 25px;
        }

        .loading {
            color: #aaa;
            font-size: 16px;
            margin: 20px 0;
        }

    </style>
</head>
<body>
<div class="carousel-container">
    <div class="carousel">
        <!-- Легкий уровень -->
        <div class="carousel-level" data-level="easy">
            <h1>ЛЕГКИЙ</h1>
            <div class="subtitle">Уровень</div>
            <div class="loading">Загрузка поз...</div>
            <div class="cards-grid" id="easy-cards">
                <div class="scratch-container">
                    <canvas class="scratch-canvas"></canvas>
                    <img class="pose-image" alt="Поза">
                </div>
                <div class="scratch-container">
                    <canvas class="scratch-canvas"></canvas>
                    <img class="pose-image" alt="Поза">
                </div>
                <div class="scratch-container">
                    <canvas class="scratch-canvas"></canvas>
                    <img class="pose-image" alt="Поза">
                </div>
                <div class="scratch-container">
                    <canvas class="scratch-canvas"></canvas>
                    <img class="pose-image" alt="Поза">
                </div>
            </div>
        </div>

        <!-- Средний уровень -->
        <div class="carousel-level" data-level="medium">
            <h1>СРЕДНИЙ</h1>
            <div class="subtitle">Уровень</div>
            <div class="loading">Загрузка поз...</div>
            <div class="cards-grid" id="medium-cards">
                <div class="scratch-container">
                    <canvas class="scratch-canvas"></canvas>
                    <img class="pose-image" alt="Поза">
                </div>
                <div class="scratch-container">
                    <canvas class="scratch-canvas"></canvas>
                    <img class="pose-image" alt="Поза">
                </div>
                <div class="scratch-container">
                    <canvas class="scratch-canvas"></canvas>
                    <img class="pose-image" alt="Поза">
                </div>
                <div class="scratch-container">
                    <canvas class="scratch-canvas"></canvas>
                    <img class="pose-image" alt="Поза">
                </div>
            </div>
        </div>

        <!-- Сложный уровень -->
        <div class="carousel-level" data-level="hard">
            <h1>СЛОЖНЫЙ</h1>
            <div class="subtitle">Уровень</div>
            <div class="loading">Загрузка поз...</div>
            <div class="cards-grid" id="hard-cards">
                <div class="scratch-container">
                    <canvas class="scratch-canvas"></canvas>
                    <img class="pose-image" alt="Поза">
                </div>
                <div class="scratch-container">
                    <canvas class="scratch-canvas"></canvas>
                    <img class="pose-image" alt="Поза">
                </div>
                <div class="scratch-container">
                    <canvas class="scratch-canvas"></canvas>
                    <img class="pose-image" alt="Поза">
                </div>
                <div class="scratch-container">
                    <canvas class="scratch-canvas"></canvas>
                    <img class="pose-image" alt="Поза">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="pagination-container">
    <div class="pagination-arrow left">❮</div>

    <div class="pagination">
        <div class="pagination-dot active" data-index="0"></div>
        <div class="pagination-dot" data-index="1"></div>
        <div class="pagination-dot" data-index="2"></div>
    </div>

    <div class="pagination-arrow right">❯</div>
</div>

<div class="task-container">
    <div class="task-carousel">
        <div class="task-level" data-level="easy">
            <div class="task">
                <canvas class="scratch-canvas" id="taskCard-easy"></canvas>
            </div>
        </div>
        <div class="task-level" data-level="medium">
            <div class="task">
                <canvas class="scratch-canvas" id="taskCard-medium"></canvas>
            </div>
        </div>
        <div class="task-level" data-level="hard">
            <div class="task">
                <canvas class="scratch-canvas" id="taskCard-hard"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="instructions">Потрите область карточки, чтобы увидеть позу или задание</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
    // Загрузка данных из poses_cleaned_final.json
    fetch('poses_cleaned_final.json')
        .then(response => response.json())
        .then(posesData => {
            // Функция для получения случайных уникальных поз по уровню сложности
            function getRandomPosesByLevel(level, count) {
                const filteredPoses = posesData.poses.filter(pose =>
                    pose.types.level.includes(level)
                );
                const shuffled = [...filteredPoses].sort(() => 0.5 - Math.random());
                return shuffled.slice(0, count);
            }

            // Загрузка поз для каждого уровня
            function loadPoses() {
                const levels = ['easy', 'medium', 'hard'];

                levels.forEach(level => {
                    const randomPoses = getRandomPosesByLevel(level, 4);
                    const cardsContainer = document.getElementById(`${level}-cards`);
                    const loadingElement = cardsContainer.previousElementSibling;

                    // Показываем контейнер с карточками и скрываем элемент загрузки
                    cardsContainer.style.display = 'grid';
                    loadingElement.style.display = 'none';

                    // Заполняем карточки изображениями поз
                    const poseImages = cardsContainer.querySelectorAll('.pose-image');
                    randomPoses.forEach((pose, index) => {
                        poseImages[index].src = pose.image_url;
                        poseImages[index].alt = pose.title;

                        // Добавляем описание в атрибут data-description
                        poseImages[index].dataset.description = pose.description;
                    });
                });

                // Инициализируем карусель после загрузки данных
                initCarousel();
            }

            // Карусель уровней
            function initCarousel() {
                const carousel = document.querySelector('.carousel');
                const taskCarousel = document.querySelector('.task-carousel');
                const levels = document.querySelectorAll('.carousel-level');
                const dots = document.querySelectorAll('.pagination-dot');
                const arrows = document.querySelectorAll('.pagination-arrow');
                let currentIndex = 0;

                function updateCarousel() {
                    const translateValue = `translateX(-${currentIndex * 33.333}%)`;
                    carousel.style.transform = translateValue;
                    taskCarousel.style.transform = translateValue;

                    // Обновляем пагинацию
                    dots.forEach((dot, index) => {
                        dot.classList.toggle('active', index === currentIndex);
                    });

                    // Обновляем состояние стрелок
                    arrows[0].classList.toggle('disabled', currentIndex === 0);
                    arrows[1].classList.toggle('disabled', currentIndex === levels.length - 1);
                }

                // Обработчики для стрелок
                arrows.forEach(arrow => {
                    arrow.addEventListener('click', function () {
                        if (this.classList.contains('left')) {
                            currentIndex = Math.max(0, currentIndex - 1);
                        } else {
                            currentIndex = Math.min(levels.length - 1, currentIndex + 1);
                        }
                        updateCarousel();
                    });
                });

                // Обработчики для точек пагинации
                dots.forEach(dot => {
                    dot.addEventListener('click', function () {
                        currentIndex = parseInt(this.getAttribute('data-index'));
                        updateCarousel();
                    });
                });

                // Инициализация скретч-карточек
                function initScratchCards() {
                    const canvases = document.querySelectorAll('.scratch-canvas');
                    canvases.forEach(canvas => {
                        initScratchEffect(canvas);
                    });
                }

                function initScratchEffect(canvas) {
                    if (!canvas) return;

                    const ctx = canvas.getContext('2d');

                    // Устанавливаем размеры canvas в соответствии с CSS размерами
                    canvas.width = canvas.offsetWidth;
                    canvas.height = canvas.offsetHeight;

                    // Заполняем слой цветом (слой для стирания)
                    ctx.fillStyle = '#1B1B1B';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // Текст под слоем (пример)
                    ctx.fillStyle = '#E91E63';
                    ctx.font = '20px Arial';
                    ctx.textAlign = 'center';

                    // Разный текст для карточек поз и задания
                    if (canvas.id.includes('taskCard')) {
                        ctx.fillText('Задание', canvas.width / 2, canvas.height / 2);
                    } else {
                        ctx.fillText('Поза', canvas.width / 2, canvas.height / 2);
                    }

                    let isDrawing = false;
                    let lastX = 0;
                    let lastY = 0;

                    // Вспомогательная функция для получения координат относительно canvas
                    function getPointerPos(e) {
                        const rect = canvas.getBoundingClientRect();
                        let x, y;

                        if (e.touches && e.touches.length > 0) {
                            x = e.touches[0].clientX - rect.left;
                            y = e.touches[0].clientY - rect.top;
                        } else {
                            x = e.clientX - rect.left;
                            y = e.clientY - rect.top;
                        }

                        return {x, y};
                    }

                    function startDrawing(e) {
                        e.preventDefault();
                        isDrawing = true;
                        const pos = getPointerPos(e);
                        lastX = pos.x;
                        lastY = pos.y;
                    }

                    function draw(e) {
                        if (!isDrawing) return;
                        e.preventDefault();

                        const pos = getPointerPos(e);

                        ctx.globalCompositeOperation = 'destination-out';
                        ctx.lineWidth = 20;
                        ctx.lineCap = 'round';

                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                        ctx.lineTo(pos.x, pos.y);
                        ctx.stroke();

                        lastX = pos.x;
                        lastY = pos.y;

                        // Показываем изображение позы, когда достаточно стерто
                        checkReveal(canvas);
                    }

                    function stopDrawing(e) {
                        e.preventDefault();
                        isDrawing = false;
                    }

                    // Проверяем, достаточно ли стерто, чтобы показать изображение
                    function checkReveal(canvas) {
                        const ctx = canvas.getContext('2d');
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const pixels = imageData.data;
                        let transparentPixels = 0;

                        for (let i = 3; i < pixels.length; i += 4) {
                            if (pixels[i] === 0) {
                                transparentPixels++;
                            }
                        }

                        const transparentPercent = (transparentPixels / (pixels.length / 4)) * 100;

                        if (transparentPercent > 30) { // 30% стерто - показываем изображение
                            const container = canvas.closest('.scratch-container');
                            if (container) {
                                const poseImage = container.querySelector('.pose-image');
                                if (poseImage) {
                                    poseImage.style.display = 'block';
                                }
                            }
                        }
                    }

                    // Подписываемся на события мыши и касания
                    canvas.addEventListener('mousedown', startDrawing);
                    canvas.addEventListener('touchstart', startDrawing);

                    canvas.addEventListener('mousemove', draw);
                    canvas.addEventListener('touchmove', draw);

                    canvas.addEventListener('mouseup', stopDrawing);
                    canvas.addEventListener('mouseout', stopDrawing);
                    canvas.addEventListener('touchend', stopDrawing);
                    canvas.addEventListener('touchcancel', stopDrawing);
                }

                updateCarousel();
                initScratchCards();
            }

            loadPoses();
        })
        .catch(error => {
            console.error('Error loading poses data:', error);
            // Можно добавить обработку ошибки загрузки данных
        });
});
</script>
</body>
</html>